---

# _backup server_ : Add Host-s to ssh config.
- block:
    - name: ssh | Define ssh hostnames
      set_fact:
        r_ssh_hosts: >
          {{  [{ 'ssh_host':     item.ssh_host
               , 'ssh_hostname': item.ssh_hostname | default(ansible_host)
              }] + r_ssh_hosts
          }}
      loop: "{{ _backup_scripts }}"

    - name: ssh | Define ssh config content
      set_fact:
        r_ssh_hosts: |
          {% for h in r_ssh_hosts %}
            Host {{ h.ssh_host }}
              HostName {{ h.ssh_hostname }}
              User {{ ansible_user_id }}
          {% endfor %}

    - name: ssh | (backup_server) Add or remove host from ssh config
      blockinfile:
        block: "{{ r_ssh_hosts }}"
        state: >-
          {{ 'present' if run_mode != 'uninstall' else 'absent' }}
        marker: "# {mark} ANSIBLE MANAGED BLOCK bh-backups of {{ host_id }}"
        owner:  "{{ backup_user }}"
        mode:   '0600'
        backup: yes
        path: >-
          {{ backup_user_dir + '/.ssh/config' }}
        create: yes

  delegate_to: "{{ backup_server }}"
  tags:
    - 'rsnapshot_ssh_hosts'
    - 'rsnapshot_db'

# _localhost_ : Obtain ssh host pubkeys.
- block:
    - name: ssh | (local) Ensure ssh host public keys directory exists
      file:
        path: "{{ host_ssh_pubkeys_dir }}"
        state: directory
      delegate_to: localhost

    - name: ssh | Find ssh host public keys
      find:
        paths: '/etc/ssh'
        patterns: '^ssh_host_[^/]+_key\.pub$'
        use_regex:  true
        file_type:  'file'
      register: ssh_host_keys_found

    - name: ssh | (local) Obtain ssh host public keys
      ansible.builtin.fetch:
        src:  "{{ item.path }}"
        dest: "{{ host_ssh_pubkeys_dir + '/' }}"
        flat: yes
      loop: "{{ ssh_host_keys_found.files }}"

  tags:
    - 'ssh_host_access'

# _localhost_ : Parse saved ssh host keys on _localhost_.
- block:
    - name: ssh | (local) Find backup server user ssh public keys
      find:
        paths:      "{{ server_ssh_pubkeys_dir }}"
        patterns:   '^id_rsa.pub$'
        use_regex:  true
        file_type:  'file'
      register: server_ssh_pubkeys_found
      delegate_to: localhost

    - name: ssh | Add or remove backup server user from authorized_keys
      authorized_key:
        user:   "{{ ansible_user_id }}"
        state: >-
          {{ 'present' if run_mode != 'uninstall' else 'absent' }}
        key:    "{{ lookup('file', item.path) }}"
      loop: "{{ server_ssh_pubkeys_found.files }}"

  tags:
    - 'ssh_host_access'

- block:
    - name: ssh | (local) Find ssh host public keys
      find:
        paths: "{{ host_ssh_pubkeys_dir }}"
        patterns: '^ssh_host_[^/]+_key\.pub$'
        use_regex:  true
        file_type:  'file'
      register: host_ssh_pubkeys_found
      delegate_to: localhost

    - name: ssh | Parse ssh host public keys
      set_fact:
        ssh_host_keys: >
          {{  [ dict( ['keytype', 'key', 'host']
                        | zip(lookup('file', item.path).split(' '))
                    )
              ] + ssh_host_keys }}
      loop: "{{ host_ssh_pubkeys_found.files }}"
    # '

    - name: ssh | (backup_server) Add host to backup server's known_hosts
      known_hosts:
        name: "{{ ansible_host }}"
        key:  "{{ ansible_host + ' ' + item.keytype + ' ' + item.key }}"
        hash_host: yes
      loop: "{{ ssh_host_keys }}"
      delegate_to: "{{ backup_server }}"

  tags:
    - 'ssh_host_access'

