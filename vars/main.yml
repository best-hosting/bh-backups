---
# Current server snapshot root. Does NOT include trailing slash!
r_snapshot_root: >-
  {{ hostvars[backup_server]['r_backup_root'] + '/' + inventory_hostname }}

# vars file for bh-backups
rsync_filters_dir: "{{ install_path + '/rsnapshot.d' }}"
rsync_filters_libdir: "{{ install_path + '/rsnapshot.d/lib' }}"

r_data_templates: []
r_data_files: []

r_backup_filters: {}
r_backup_script_confs: {}

# By default, at least ssh config entry for current host is required.
r_ssh_hosts:
  - ssh_host: "{{ inventory_hostname }}"
    ssh_hostname: "{{ ansible_host }}"

ssh_host_pubkeys_db_dir: "{{ playbook_dir + '/ssh_host_pubkeys/' + inventory_hostname }}"
ssh_host_keys: []

# I _need_ gather facts run against backup_server, to initialize these
# variables!
backup_user: "{{ hostvars[backup_server]['ansible_user_id'] }}"
backup_user_dir: "{{ hostvars[backup_server]['ansible_user_dir'] }}"

ssh_pubkeys_db_dir: "{{ playbook_dir + '/ssh_pubkeys' }}"
ssh_pubkeys_backup_server_dir: >-
  {{ ssh_pubkeys_db_dir + '/' + backup_server + '/' + backup_user }}
ssh_pubkeys_dir: >-
  {{ ssh_pubkeys_db_dir + '/' + inventory_hostname + '/' + ansible_user_id }}

rsnapshot_pkgs:
- 'rsnapshot'
# mysql script deps
- 'socat'
- >-
  {%- if ansible_distribution == "Debian"
        and ansible_distribution_major_version | int > 7 -%}
      mariadb-client
  {%- elif ansible_distribution == "Debian" -%}
      mysql-client
  {%- endif %}
- 'postgresql-client'

# Internal r_backups version.
r_backups2: []
# Internal r_backup_scripts version.
r_backup_scripts2: []

r_backup_scripts_mysql: []
r_backup_scripts_pgsql: []

# Whether to set up backups of mysql. Guessed from backup scripts.
db_mysql: >-
  {{ r_backup_scripts
      | selectattr('name', 'equalto', 'mysql')
      | list | length > 0
  }}

# Whether to set up backups of postgresql. Guessed from backup scripts.
db_postgresql: >-
  {{ r_backup_scripts
      | selectattr('name', 'equalto', 'pgsql')
      | list | length > 0
  }}

rsnapshot_conf: "{{ install_path + '/rsnapshot.' + inventory_hostname + '.conf' }}"

rsnapshot_cron_file: >-
  {{ 'rsnapshot-' + inventory_hostname | regex_replace('[^a-zA-Z0-9_-]', '_') }}

r_files_count: {}
r_size: {}

r_scripts_file_count: {}
r_scripts_size: {}

r_files_count_raw: []
r_files_count_cache: {}
r_size_raw: []
r_size_cache: {}

r_scripts_files_count_raw: []
r_scripts_files_count_cache: {}
r_scripts_size_raw: []
r_scripts_size_cache: {}

# Cache files for calculated file count and sizes.
r_cache_dir: "{{ playbook_dir + '/rsnapshot_cache' }}"
r_files_count_cache_file: >-
  {{ r_cache_dir + '/' + inventory_hostname + '-files_count.yml' }}
r_size_cache_file: >-
  {{ r_cache_dir + '/' + inventory_hostname + '-size.yml' }}

r_scripts_files_count_cache_file: >-
  {{ r_cache_dir + '/' + inventory_hostname + '-scripts-files_count.yml' }}
r_scripts_size_cache_file: >-
  {{ r_cache_dir + '/' + inventory_hostname + '-scripts-size.yml' }}

